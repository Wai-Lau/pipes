<p>Count numbers: <output id="result"></output></p>
<div id="map" style="width: 100%; height:100%; position: absolute; overflow: visible !important;"></div>

<script> connect("<%= @url %>") </script>
<script id="worker1" type="javascript/worker">
function getCurrentLocation() {
  postMessage("position please");
}

getCurrentLocation();
setInterval(getCurrentLocation, 5000);
</script>
<script>
var w;

if(typeof(Worker) !== "undefined") {
  if(typeof(w) == "undefined") {
    var blob = new Blob([document.querySelector('#worker1').textContent]);
    w = new Worker(window.URL.createObjectURL(blob));
  }
	 function updateUserPosition(position) {
	    console.log('sending ajax')
	    $.ajax({
		url: "https://pipes.wailau.net/moves",
		method: "POST",
		data: {
		    move : {
			content: position,
			url: GLOBAL_URL
		    }
		},
		contentType: "multipart/form-data",
		success: function(data){
		    console.log(data);
		},
		error: function(errMsg) {
		    console.log(JSON.stringify(errMsg));
		}
	    });
	}

	function success(pos) {
	  console.log(JSON.stringify(pos.coords));
	  let position = {
	      lat: pos.coords.latitude,
	      lng: pos.coords.longitude
	  }
	  updateUserPosition(position);
	  console.log(position);
	}

	function error(err) {
	  console.warn(`ERROR(${err.code}): ${err.message}`);
	}

	var options = {
	  enableHighAccuracy: true,
	  maximumAge: 0
	};

 w.onmessage = function(event) {
    w.postMessage(navigator.geolocation.getCurrentPosition(success, error, options));
  };
} else {
  document.getElementById("result").innerHTML = "Sorry, your browser does not support Web Workers...";
}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGBoYPW4Ll4SEInruMMxa8fvQhTujmA7w&callback=initMap"></script>
